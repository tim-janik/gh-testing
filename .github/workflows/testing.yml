# This Source Code Form is licensed MPL-2.0: http://mozilla.org/MPL/2.0

# Linting: xclip -sel c <.github/workflows/testing.yml # https://rhysd.github.io/actionlint/

on:
  push:
    branches: ['master', 'trunk', 'wip/**']
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+*'

jobs:


  Focal-CI:
    runs-on: ubuntu-latest
    container: { image: 'ghcr.io/tim-janik/anklang-ci:focal-latest' }
    steps:
    - name: 'Fixup $USER and $HOME'
      run: |
        set -x
        id
        pwd
        ls -ald .
        UGID=$(stat -c %u:%g .) && sudo usermod -o -u "${UGID%:*}" `id -nu` && sudo groupmod -o -g "${UGID#*:}" `id -ng`
        id
        echo HOME=$HOME
        ls -ald .
        ls -ald ~
        ls -ald $HOME
        ls -ald $RUNNER_TEMP
        env
    - name: 'Git Checkout'
      run: |
        git --version && git clone -q --recurse-submodules https://github.com/$GITHUB_REPOSITORY .
        git fetch origin $GITHUB_REF # e.g. refs/pull/nnn/merge
        [[ $GITHUB_REF =~ ^refs/heads/ ]] && BRANCHORSHA=$GITHUB_REF_NAME || BRANCHORSHA=$GITHUB_SHA
        git checkout -q $BRANCHORSHA && git describe --always && git -P log -1 --oneline
    - run: |
        git describe | tee git-describe && ls -al
    - uses: actions/upload-artifact@v4
      with: { name: assets, path: ./ }
